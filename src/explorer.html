<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HardClaw Explorer</title>
    <style>
        :root {
            --bg-color: #0d1117;
            --card-bg: #161b22;
            --text-color: #c9d1d9;
            --accent-color: #00ff41;
            /* Hacker/Matrix Green */
            --accent-dim: #008f11;
            --border-color: #30363d;
            --code-font: 'Courier New', Courier, monospace;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        h1,
        h2,
        h3 {
            color: var(--accent-color);
            font-family: var(--code-font);
            margin: 0;
        }

        h1 span {
            font-size: 0.6em;
            color: var(--text-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 20px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--accent-color);
            font-family: var(--code-font);
        }

        .stat-label {
            color: #8b949e;
            font-size: 0.9em;
        }

        input[type="text"] {
            width: 100%;
            background-color: #0d1117;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 10px;
            font-family: var(--code-font);
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-family: var(--code-font);
        }

        th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid var(--border-color);
            color: #8b949e;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        tr:hover {
            background-color: #21262d;
        }

        a {
            color: #58a6ff;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .status-dot {
            height: 10px;
            width: 10px;
            background-color: var(--accent-color);
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            box-shadow: 0 0 5px var(--accent-color);
        }

        .hash {
            color: #79c0ff;
        }

        .refresh-btn {
            background: none;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            padding: 5px 15px;
            cursor: pointer;
            font-family: var(--code-font);
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: var(--accent-dim);
            color: white;
        }

        /* Helper classes for lint compliance */
        .text-large {
            font-size: 1.2em;
        }

        .flex-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .hidden {
            display: none;
        }

        .code-block {
            overflow-x: auto;
        }

        .genesis-card {
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.1);
            margin-bottom: 30px;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>HARDCLAW <span>// EXPLORER</span></h1>
            <div id="connection-status">
                <span class="status-dot"></span> Online
            </div>
        </header>

        <div class="stats-grid">
            <div class="card">
                <div class="stat-label">Block Height</div>
                <div class="stat-value" id="stat-height">-</div>
            </div>
            <div class="card">
                <div class="stat-label">Chain ID</div>
                <div class="stat-value text-large" id="stat-chain">-</div>
            </div>
            <div class="card">
                <div class="stat-label">Peers</div>
                <div class="stat-value" id="stat-peers">-</div>
            </div>
            <div class="card">
                <div class="stat-label">Pending Jobs</div>
                <div class="stat-value" id="stat-mempool">-</div>
            </div>
        </div>

        <input type="text" id="search-box" placeholder="Search by Block Hash, Job ID, or Address...">

        <div id="genesis-container"></div>

        <div class="card">
            <div class="flex-header">
                <h3>LATEST BLOCKS</h3>
                <button class="refresh-btn" onclick="fetchRecentBlocks()">REFRESH</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Height</th>
                        <th>Hash</th>
                        <th>Parent</th>
                        <th>Jobs</th>
                    </tr>
                </thead>
                <tbody id="blocks-table">
                    <!-- Blocks populated here -->
                </tbody>
            </table>
        </div>

        <br>

        <div id="result-area" class="card hidden">
            <h3 id="result-title">SEARCH RESULT</h3>
            <pre id="result-content" class="code-block"></pre>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        const resultArea = document.getElementById('result-area');

        async function fetchStats() {
            try {
                const res = await fetch(`${API_BASE}/status`);
                const data = await res.json();
                document.getElementById('stat-height').textContent = data.height;
                document.getElementById('stat-chain').textContent = data.chain_id || 'mainnet';
                document.getElementById('stat-peers').textContent = data.peer_count;
                document.getElementById('stat-mempool').textContent = data.mempool_size;
            } catch (e) {
                console.error("Failed to fetch stats", e);
            }
        }

        async function fetchRecentBlocks() {
            try {
                const res = await fetch(`${API_BASE}/blocks/recent`);
                const blocks = await res.json();
                const tbody = document.getElementById('blocks-table');
                while (tbody.firstChild) tbody.removeChild(tbody.firstChild);

                blocks.forEach(block => {
                    const row = document.createElement('tr');

                    const tdHeight = document.createElement('td');
                    tdHeight.textContent = block.height;
                    if (block.is_genesis) {
                        const badge = document.createElement('span');
                        badge.textContent = ' [GENESIS]';
                        badge.style.color = 'var(--accent-color)';
                        badge.style.fontSize = '0.8em';
                        tdHeight.appendChild(badge);
                    }

                    const tdHash = document.createElement('td');
                    tdHash.className = 'hash';
                    tdHash.style.cursor = 'pointer';
                    tdHash.textContent = block.hash.substring(0, 16) + '...';
                    tdHash.addEventListener('click', function() { showBlock(block.hash); });

                    const tdParent = document.createElement('td');
                    tdParent.className = 'hash';
                    tdParent.textContent = block.parent_hash.substring(0, 16) + '...';

                    const tdTx = document.createElement('td');
                    tdTx.textContent = block.tx_count;

                    row.appendChild(tdHeight);
                    row.appendChild(tdHash);
                    row.appendChild(tdParent);
                    row.appendChild(tdTx);
                    tbody.appendChild(row);
                });
            } catch (e) {
                console.error("Failed to fetch recent blocks", e);
            }
        }

        async function fetchGenesisInfo() {
            try {
                const res = await fetch(`${API_BASE}/genesis`);
                if (!res.ok) return;
                const data = await res.json();
                if (data.error) return;

                const container = document.getElementById('genesis-container');
                if (document.getElementById('genesis-job-card')) return;

                const card = document.createElement('div');
                card.className = 'card genesis-card';
                card.id = 'genesis-job-card';

                const header = document.createElement('div');
                header.className = 'flex-header';

                const title = document.createElement('h3');
                title.textContent = 'GENESIS BLOCK ';
                const subtitle = document.createElement('span');
                subtitle.style.fontSize = '0.7em';
                subtitle.style.color = 'var(--text-color)';
                subtitle.textContent = '// SYSTEM';
                title.appendChild(subtitle);

                const hashSpan = document.createElement('span');
                hashSpan.className = 'hash';
                hashSpan.textContent = data.hash ? data.hash.substring(0, 16) + '...' : '';

                header.appendChild(title);
                header.appendChild(hashSpan);
                card.appendChild(header);

                if (data.genesis_job) {
                    const desc = document.createElement('p');
                    desc.style.color = 'var(--text-color)';
                    desc.style.marginBottom = '15px';
                    desc.textContent = data.genesis_job.description || 'Genesis bootstrap job';
                    card.appendChild(desc);

                    const grid = document.createElement('div');
                    grid.style.display = 'grid';
                    grid.style.gridTemplateColumns = '1fr 1fr';
                    grid.style.gap = '10px';
                    grid.style.fontSize = '0.9em';
                    grid.style.color = '#8b949e';

                    const bountyDiv = document.createElement('div');
                    bountyDiv.textContent = 'BOUNTY: ';
                    const bountyVal = document.createElement('span');
                    bountyVal.style.color = 'var(--accent-color)';
                    bountyVal.textContent = data.genesis_job.bounty + ' HCLAW';
                    bountyDiv.appendChild(bountyVal);

                    const statusDiv = document.createElement('div');
                    statusDiv.textContent = 'STATUS: ';
                    const statusVal = document.createElement('span');
                    statusVal.style.color = 'var(--accent-color)';
                    statusVal.textContent = data.genesis_job.status || 'Active';
                    statusDiv.appendChild(statusVal);

                    const typeDiv = document.createElement('div');
                    typeDiv.textContent = 'TYPE: ';
                    const typeVal = document.createElement('span');
                    typeVal.style.color = 'var(--accent-color)';
                    typeVal.textContent = data.genesis_job.job_type || 'System';
                    typeDiv.appendChild(typeVal);

                    const proposerDiv = document.createElement('div');
                    proposerDiv.textContent = 'PROPOSER: ';
                    const proposerVal = document.createElement('span');
                    proposerVal.className = 'hash';
                    proposerVal.textContent = data.proposer ? data.proposer.substring(0, 16) + '...' : '-';
                    proposerDiv.appendChild(proposerVal);

                    grid.appendChild(bountyDiv);
                    grid.appendChild(statusDiv);
                    grid.appendChild(typeDiv);
                    grid.appendChild(proposerDiv);
                    card.appendChild(grid);
                } else {
                    const info = document.createElement('p');
                    info.style.color = '#8b949e';
                    info.textContent = 'Genesis block at height 0 â€” proposer: ' + (data.proposer || 'unknown');
                    card.appendChild(info);
                }

                container.appendChild(card);
            } catch (e) {
                console.error("Failed to fetch genesis info", e);
            }
        }

        function isHexAddress(q) {
            var stripped = q.startsWith('0x') ? q.substring(2) : q;
            return stripped.length === 40 && /^[0-9a-fA-F]{40}$/.test(stripped);
        }

        async function search(query) {
            query = query.trim();
            if (!query) return;

            const resultTitle = document.getElementById('result-title');
            const resultContent = document.getElementById('result-content');

            resultArea.classList.remove('hidden');
            resultArea.style.display = 'block';
            resultContent.textContent = "Searching...";

            try {
                // Try Address Balance first (with or without 0x prefix)
                if (isHexAddress(query)) {
                    var addrQuery = query.startsWith('0x') ? query : '0x' + query;
                    var res = await fetch(`${API_BASE}/balance/${addrQuery}`);
                    if (res.ok) {
                        var data = await res.json();
                        if (!data.error) {
                            resultTitle.textContent = "ACCOUNT: " + addrQuery;
                            resultContent.textContent = JSON.stringify(data, null, 2);
                            return;
                        }
                    }
                }

                // Try Block
                var res = await fetch(`${API_BASE}/block/${query}`);
                if (res.ok) {
                    var data = await res.json();
                    if (!data.error) {
                        resultTitle.textContent = "BLOCK: " + query;
                        resultContent.textContent = JSON.stringify(data, null, 2);
                        return;
                    }
                }

                // Try Job
                res = await fetch(`${API_BASE}/job/${query}`);
                if (res.ok) {
                    var data = await res.json();
                    if (!data.error) {
                        resultTitle.textContent = "JOB: " + query;
                        resultContent.textContent = JSON.stringify(data, null, 2);
                        return;
                    }
                }

                resultContent.textContent = "No results found.";
            } catch (e) {
                resultContent.textContent = "Search failed: " + e.message;
            }
        }

        function showBlock(hash) {
            document.getElementById('search-box').value = hash;
            search(hash);
        }

        document.getElementById('search-box').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                search(this.value);
            }
        });

        // Initialize
        fetchStats();
        fetchRecentBlocks();
        fetchGenesisInfo();
        setInterval(fetchStats, 5000);
        setInterval(fetchRecentBlocks, 10000);
    </script>
</body>

</html>